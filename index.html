<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BearAcc Pro</title>
    <!-- Teddy Bear Icon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß∏</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, setDoc, getDocs 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBXY_kuplXAslH11t4rLRVo0-kyqmt4m3E",
          authDomain: "lo-acc-fv.firebaseapp.com",
          projectId: "lo-acc-fv",
          storageBucket: "lo-acc-fv.firebasestorage.app",
          messagingSenderId: "757484054386",
          appId: "1:757484054386:web:a4d7825732c72183ec9feb",
          measurementId: "G-372P84L4GG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Expose DB functions to global window
        window.db = db;
        window.collection = collection;
        window.doc = doc;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.setDoc = setDoc;
        window.getDocs = getDocs;

        signInAnonymously(auth).then(() => {
            console.log("Connected to Firebase");
            window.initApp();
        }).catch((error) => {
            console.error("Firebase Auth Error", error);
            alert("L·ªói k·∫øt n·ªëi Server! Vui l√≤ng reload.");
        });
    </script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                    mono: ['JetBrains Mono', 'monospace'],
                },
                extend: {
                    animation: {
                        'slide-in': 'slideIn 0.4s ease-out forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                        'scale-in': 'scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                    },
                    keyframes: {
                        slideIn: {
                            'from': { opacity: '0', transform: 'translateY(20px)' },
                            'to': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            'from': { opacity: '0' },
                            'to': { opacity: '1' },
                        },
                        scaleIn: {
                            'from': { transform: 'scale(0.9)', opacity: '0' },
                            'to': { transform: 'scale(1)', opacity: '1' },
                        },
                        popIn: {
                            'from': { opacity: '0', transform: 'translate(-50%, -40%) scale(0.9)' },
                            'to': { opacity: '1', transform: 'translate(-50%, -50%) scale(1)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .dark ::-webkit-scrollbar { width: 8px; }
        .dark ::-webkit-scrollbar-track { background: #0f172a; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #475569; }
        body { transition: background-color 0.3s, color 0.3s; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen font-sans pb-20">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md p-8 rounded-2xl shadow-2xl border bg-slate-900 border-slate-800 animate-scale-in">
            <div class="flex flex-col items-center mb-6">
                <!-- Teddy Bear Icon -->
                <div class="bg-amber-600 p-4 rounded-full mb-4 shadow-lg shadow-amber-500/30">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M224,96a56.06,56.06,0,0,0-56-56,8,8,0,0,0-8,8,40,40,0,0,1-80,0,8,8,0,0,0-8-8,56.06,56.06,0,0,0-56,56,8,8,0,0,0,8,8,40,40,0,0,1,33.84,18.78,56.12,56.12,0,0,0,84.32,0A40,40,0,0,1,176,104,8,8,0,0,0,224,96ZM48,96a40,40,0,0,1,28.62-38.34A56,56,0,0,0,32,96c0,13.23,7.26,24.83,18.09,31.72A40.16,40.16,0,0,1,48,96Zm174.12,32.3A56.1,56.1,0,0,0,186,171.18c4.37,8.22,6.58,16.59,6,24.23-.74,9.65-6.69,17-15.65,19.33a54.54,54.54,0,0,1-13.67,1.72c-9.1,0-19.36-2.58-29.07-7.29a8,8,0,0,0-7.22,0c-9.71,4.71-20,7.29-29.07,7.29a54.54,54.54,0,0,1-13.67-1.72c-9-2.31-14.91-9.68-15.65-19.33-.55-7.64,1.66-16,6-24.23a56,56,0,0,0,0-85.36c.7-1.32,1.44-2.61,2.22-3.86a56,56,0,0,0,145.87,49.22ZM92,152a12,12,0,1,1,12-12A12,12,0,0,1,92,152Zm72,0a12,12,0,1,1,12-12A12,12,0,0,1,164,152Z"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-amber-500">BearAcc Pro</h1>
                <p class="text-slate-400 flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Firebase Live Sync</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold uppercase mb-1.5 opacity-70">Username</label>
                    <input type="text" id="login-username" class="w-full px-4 py-3 rounded-xl outline-none border-2 bg-slate-800 border-slate-700 focus:border-amber-500 transition-colors placeholder-slate-500" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" autofocus>
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase mb-1.5 opacity-70">Password</label>
                    <input type="password" id="login-password" class="w-full px-4 py-3 rounded-xl outline-none border-2 bg-slate-800 border-slate-700 focus:border-amber-500 transition-colors placeholder-slate-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div id="login-error" class="hidden p-3 rounded-lg bg-rose-500/10 text-rose-500 text-sm font-bold flex items-center gap-2">
                    <i class="ph ph-warning-circle"></i> <span>Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u!</span>
                </div>
                <div id="loading-msg" class="hidden text-center text-amber-400 font-bold text-sm animate-pulse">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ server...</div>
                <button type="submit" id="btn-login" class="w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-amber-500/30 active:scale-95">ƒêƒÉng Nh·∫≠p</button>
            </form>
        </div>
    </div>

    <!-- APP SCREEN -->
    <div id="app-screen" class="hidden">
        <header class="backdrop-blur-md sticky top-0 z-50 border-b shadow-sm transition-colors duration-300 bg-slate-900/80 border-slate-800">
            <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-amber-600 p-1.5 rounded-lg text-white shadow-lg shadow-amber-500/30">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M224,96a56.06,56.06,0,0,0-56-56,8,8,0,0,0-8,8,40,40,0,0,1-80,0,8,8,0,0,0-8-8,56.06,56.06,0,0,0-56,56,8,8,0,0,0,8,8,40,40,0,0,1,33.84,18.78,56.12,56.12,0,0,0,84.32,0A40,40,0,0,1,176,104,8,8,0,0,0,224,96ZM48,96a40,40,0,0,1,28.62-38.34A56,56,0,0,0,32,96c0,13.23,7.26,24.83,18.09,31.72A40.16,40.16,0,0,1,48,96Zm174.12,32.3A56.1,56.1,0,0,0,186,171.18c4.37,8.22,6.58,16.59,6,24.23-.74,9.65-6.69,17-15.65,19.33a54.54,54.54,0,0,1-13.67,1.72c-9.1,0-19.36-2.58-29.07-7.29a8,8,0,0,0-7.22,0c-9.71,4.71-20,7.29-29.07,7.29a54.54,54.54,0,0,1-13.67-1.72c-9-2.31-14.91-9.68-15.65-19.33-.55-7.64,1.66-16,6-24.23a56,56,0,0,0,0-85.36c.7-1.32,1.44-2.61,2.22-3.86a56,56,0,0,0,145.87,49.22ZM92,152a12,12,0,1,1,12-12A12,12,0,0,1,92,152Zm72,0a12,12,0,1,1,12-12A12,12,0,0,1,164,152Z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold leading-none text-amber-500">BearAcc Pro</h1>
                        <div class="flex items-center gap-2 mt-1">
                            <span id="user-role-badge" class="text-[10px] font-bold px-1.5 py-0.5 rounded uppercase bg-rose-500 text-white">ADMIN</span>
                            <span id="user-name-display" class="text-xs font-medium text-slate-400">User</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2 md:gap-3">
                    <div id="admin-header-controls" class="flex gap-2">
                        <button onclick="showUserManageModal()" class="p-2.5 rounded-full transition-all flex items-center gap-2 bg-slate-800 text-purple-400 hover:bg-slate-700" title="Qu·∫£n l√Ω Users"><i class="ph ph-user-gear text-xl"></i></button>
                        <button onclick="showHistoryModal()" class="p-2.5 rounded-full transition-all flex items-center gap-2 bg-slate-800 text-blue-400 hover:bg-slate-700" title="L·ªãch s·ª≠ giao d·ªãch"><i class="ph ph-clock-counter-clockwise text-xl"></i></button>
                    </div>
                    <!-- Settings for Viewer -->
                    <button id="viewer-settings-btn" onclick="showViewerSettingsModal()" class="hidden p-2.5 rounded-full transition-all bg-slate-800 text-indigo-400 hover:bg-slate-700" title="C√†i ƒë·∫∑t c√° nh√¢n">
                        <i class="ph ph-gear text-xl"></i>
                    </button>
                    <button onclick="toggleTheme()" class="p-2.5 rounded-full transition-all bg-slate-800 text-yellow-400 hover:bg-slate-700">
                        <i id="theme-icon" class="ph ph-sun text-xl"></i>
                    </button>
                    <button onclick="logout()" class="p-2.5 rounded-full transition-all bg-slate-800 text-rose-400 hover:bg-slate-700" title="ƒêƒÉng xu·∫•t">
                        <i class="ph ph-sign-out text-xl"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-4 md:p-6 space-y-8">
            <!-- VIEWER STATS -->
            <div id="viewer-stats-container" class="hidden p-6 rounded-2xl border bg-slate-900 border-slate-800 shadow-lg mb-8"></div>
            
            <!-- ADMIN STATS -->
            <section id="admin-stats-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4"></section>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- SIDEBAR -->
                <div class="lg:col-span-4 space-y-6">
                    <div id="admin-controls" class="space-y-6">
                        <!-- SELL RANDOM -->
                        <div class="rounded-2xl p-6 shadow-sm border relative overflow-hidden group bg-gradient-to-br from-slate-900 to-purple-900/20 border-purple-500/30">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="font-bold text-lg flex items-center gap-2 text-white"><i class="ph ph-shuffle text-purple-500 text-xl"></i> B√°n Random</h2>
                                <span id="ready-count-badge" class="text-xs bg-purple-500 text-white px-2 py-0.5 rounded-full font-bold">0 Acc s·∫µn</span>
                            </div>
                            <div class="mb-4">
                                <label class="text-[10px] font-bold uppercase opacity-70 mb-1 block">S·ªë l∆∞·ª£ng b√°n</label>
                                <div class="flex items-center gap-2">
                                    <button onclick="adjustSellQty(-1)" class="p-2 rounded border bg-slate-800 border-slate-700 hover:bg-slate-700"><i class="ph ph-minus"></i></button>
                                    <input type="number" id="sell-qty-input" value="1" class="w-full text-center p-2 rounded border font-bold bg-slate-800 border-slate-700 outline-none" min="1">
                                    <button onclick="adjustSellQty(1)" class="p-2 rounded border bg-slate-800 border-slate-700 hover:bg-slate-700"><i class="ph ph-plus"></i></button>
                                </div>
                            </div>
                            <button onclick="requestSellRandom()" class="w-full py-3 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-bold shadow-lg shadow-purple-500/30 active:scale-95 transition-all flex justify-center items-center gap-2">
                                <i class="ph ph-currency-dollar text-xl"></i> B√°n Ngay
                            </button>
                        </div>

                        <!-- HOTMAIL GENERATOR -->
                        <div class="rounded-2xl p-6 shadow-sm transition-all bg-slate-900 border-slate-800 border hover:border-slate-700">
                            <div class="flex items-center gap-3 mb-5">
                                <div class="p-2 rounded-lg bg-blue-900/30 text-blue-400"><i class="ph ph-arrows-clockwise text-xl"></i></div>
                                <h2 class="font-bold text-lg">Hotmail Auto</h2>
                            </div>
                            <div class="space-y-4">
                                <div class="p-4 rounded-xl border border-dashed relative bg-slate-800 border-slate-700">
                                    <div class="space-y-2 font-mono text-sm">
                                        <div class="flex justify-between"><span class="text-slate-400">User:</span><span id="gen-email" class="font-semibold select-all text-white">---</span></div>
                                        <div class="flex justify-between"><span class="text-slate-400">Pass:</span><span id="gen-pass" class="font-semibold select-all text-white">---</span></div>
                                    </div>
                                </div>
                                <div class="flex gap-3">
                                    <button onclick="generateHotmail()" class="flex-1 py-2.5 rounded-xl font-medium transition-all active:scale-95 text-white bg-slate-700 hover:bg-slate-600">Random</button>
                                    <button id="btn-fill-form" onclick="fillForm()" disabled class="flex-1 border py-2.5 rounded-xl font-medium transition-all active:scale-95 flex justify-center items-center gap-2 bg-indigo-900/40 border-indigo-700 text-indigo-300 opacity-50 cursor-not-allowed">ƒêi·ªÅn <i class="ph ph-arrow-right"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- ADD ACCOUNT -->
                        <div class="rounded-2xl p-6 shadow-sm transition-all relative overflow-hidden bg-slate-900 border-slate-800 border hover:border-slate-700">
                            <div class="flex items-center gap-3 mb-5 relative z-10">
                                <div class="p-2 rounded-lg bg-emerald-900/30 text-emerald-400"><i class="ph ph-users text-xl"></i></div>
                                <h2 class="font-bold text-lg">Nh·∫≠p Li·ªáu</h2>
                            </div>
                            <form id="add-acc-form" onsubmit="handleAddAccount(event)" class="space-y-4 relative z-10">
                                <div class="space-y-3">
                                    <input type="text" id="input-username" class="w-full px-3 py-2.5 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none text-sm bg-slate-800 border-slate-700 placeholder-slate-500" placeholder="Email / Username">
                                    <input type="text" id="input-password" class="w-full px-3 py-2.5 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none text-sm bg-slate-800 border-slate-700 placeholder-slate-500" placeholder="Password">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="number" id="input-price" class="w-full px-3 py-2.5 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none text-sm bg-slate-800 border-slate-700 placeholder-slate-500" placeholder="Gi√° (VNƒê)">
                                    <input type="text" id="input-note" class="w-full px-3 py-2.5 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none text-sm bg-slate-800 border-slate-700 placeholder-slate-500" placeholder="Ghi ch√∫">
                                </div>
                                <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-emerald-500/20 transition-all active:scale-95 mt-2 flex justify-center items-center gap-2">
                                    <i class="ph ph-plus-circle text-lg"></i> Th√™m Acc
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- VIEWER PLACEHOLDER -->
                    <div id="viewer-placeholder" class="hidden h-full rounded-2xl p-8 flex flex-col items-center justify-center text-center opacity-60 border-2 border-dashed border-slate-800">
                        <i class="ph ph-shield-check text-5xl mb-4 text-slate-500"></i>
                        <h3 class="font-bold text-lg">Ch·∫ø ƒë·ªô Viewer</h3>
                        <p class="text-sm text-slate-400">Danh s√°ch t√†i kho·∫£n ƒë∆∞·ª£c ·∫©n.</p>
                    </div>
                </div>

                <!-- MAIN LIST -->
                <div class="lg:col-span-8 flex flex-col h-[800px] rounded-2xl shadow-lg overflow-hidden border bg-slate-900 border-slate-800">
                    <div id="admin-list-container" class="flex flex-col h-full">
                        <!-- HEADER AREA WITH SEARCH -->
                        <div class="p-4 border-b border-slate-800 bg-slate-900 space-y-3 z-10 sticky top-0">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                                <div class="flex items-center gap-2">
                                    <h2 class="font-bold text-lg">Kho Acc</h2>
                                    <span id="list-count-badge" class="px-2 py-0.5 rounded-md text-xs font-bold bg-slate-800 text-slate-400">0</span>
                                </div>
                                <!-- SEARCH BAR -->
                                <div class="relative w-full sm:w-64 group">
                                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 group-focus-within:text-amber-500 transition-colors"></i>
                                    <input type="text" id="search-input" oninput="handleSearch(this.value)" placeholder="T√¨m username, note..." class="w-full pl-9 pr-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-sm focus:border-amber-500 outline-none transition-all placeholder-slate-600 focus:bg-slate-950">
                                </div>
                            </div>
                            
                            <!-- FILTERS -->
                            <div class="flex p-1 rounded-lg overflow-x-auto max-w-full bg-slate-800 scrollbar-hide" id="filter-buttons">
                                <button onclick="setFilter('all')" class="filter-btn px-3 py-1.5 rounded-md text-xs font-bold capitalize bg-slate-700 text-amber-500 shadow" data-filter="all">T·∫•t c·∫£</button>
                                <button onclick="setFilter('pending')" class="filter-btn px-3 py-1.5 rounded-md text-xs font-bold capitalize text-slate-400 hover:text-slate-200" data-filter="pending">Ch·ªù</button>
                                <button onclick="setFilter('farming')" class="filter-btn px-3 py-1.5 rounded-md text-xs font-bold capitalize text-slate-400 hover:text-slate-200" data-filter="farming">ƒêang c√†y</button>
                                <button onclick="setFilter('completed')" class="filter-btn px-3 py-1.5 rounded-md text-xs font-bold capitalize text-slate-400 hover:text-slate-200" data-filter="completed">Xong</button>
                                <button onclick="setFilter('sold')" class="filter-btn px-3 py-1.5 rounded-md text-xs font-bold capitalize text-slate-400 hover:text-slate-200" data-filter="sold">ƒê√£ b√°n</button>
                            </div>
                        </div>

                        <div id="accounts-list" class="flex-1 overflow-y-auto p-5 space-y-4 bg-slate-950/50"></div>
                    </div>
                    <div id="viewer-list-placeholder" class="hidden h-full flex flex-col items-center justify-center text-slate-500">
                        <i class="ph ph-lock-key text-6xl mb-4 opacity-20"></i>
                        <p class="text-xl font-bold opacity-50">D·ªØ li·ªáu b·∫£o m·∫≠t</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL OVERLAY -->
    <div id="modal-overlay" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
        <div id="modal-content" class="w-full max-w-sm rounded-2xl p-6 shadow-2xl border animate-scale-in bg-slate-900 border-slate-700 text-white relative">
            <!-- Content Injected via JS -->
        </div>
    </div>

    <!-- LARGE MODAL OVERLAY -->
    <div id="large-modal-overlay" class="hidden fixed inset-0 z-[60] flex items-end sm:items-center justify-center sm:p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
        <div id="large-modal-content" class="w-full sm:max-w-2xl h-[80vh] sm:h-[600px] flex flex-col rounded-t-2xl sm:rounded-2xl shadow-2xl border animate-slide-in bg-slate-900 border-slate-700 text-white relative"></div>
    </div>

    <!-- CENTERED TOAST (NOTIFICATION) -->
    <div id="toast" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[100] px-6 py-4 rounded-xl shadow-2xl flex flex-col items-center justify-center gap-2 font-medium text-white transition-all duration-300 opacity-0 scale-90 invisible min-w-[200px] text-center">
        <i id="toast-icon" class="ph ph-check-circle text-4xl mb-1"></i>
        <span id="toast-message" class="text-lg">Notification</span>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let state = {
            currentUser: null,
            users: [], // Sync from Firebase
            accounts: [], // Sync from Firebase
            history: [], // Sync from Firebase
            filter: 'all',
            searchQuery: '',
            isDark: true,
            sellQuantity: 1
        };

        // --- COMMISSION LOGIC ---
        function getCommissionRate(count) {
            if (count >= 50) return 0.07;
            if (count >= 20) return 0.05;
            return 0.02;
        }

        // --- APP INITIALIZATION ---
        window.initApp = async () => {
            // Apply Theme
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme === 'light') {
                state.isDark = false;
                document.documentElement.classList.remove('dark');
            }
            updateThemeIcon();

            // Set up Realtime Listeners
            setupListeners();
            
            // Check & Seed Users if empty
            await checkAndSeedUsers();

            // Setup Auto-Updater (Client-side Timer for farming days display)
            setInterval(() => {
                if (state.currentUser && state.currentUser.role === 'admin') {
                    renderAccounts(); // Re-render to update timers visual
                }
            }, 60000);
        };

        // --- FIREBASE LISTENERS ---
        function setupListeners() {
            // Accounts
            window.onSnapshot(window.query(window.collection(window.db, "accounts")), (snapshot) => {
                state.accounts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort by createdAt desc locally for display
                state.accounts.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                
                if (state.currentUser) {
                    renderApp(); // Data change triggers render
                }
            });

            // History
            window.onSnapshot(window.query(window.collection(window.db, "history")), (snapshot) => {
                state.history = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.history.sort((a, b) => (b.soldAt || 0) - (a.soldAt || 0));
                if (state.currentUser) renderApp();
            });

            // Users
            window.onSnapshot(window.query(window.collection(window.db, "users")), (snapshot) => {
                state.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // If current user details changed in DB (e.g. password changed), update local session
                if (state.currentUser) {
                    const freshUser = state.users.find(u => u.id === state.currentUser.id);
                    if (freshUser) {
                        state.currentUser = freshUser; // Keep session sync
                        renderApp();
                    } else {
                        // User deleted? Logout
                        logout(); 
                    }
                }
            });
        }

        async function checkAndSeedUsers() {
            const snap = await window.getDocs(window.collection(window.db, "users"));
            if (snap.empty) {
                console.log("Seeding default users...");
                const defaultUsers = [
                    { id: 'admin', username: 'Admin', password: '1111', role: 'admin', name: 'Administrator' },
                    { id: 'minh', username: 'minh', password: '1234', role: 'viewer', name: 'Minh Sale' },
                    { id: 'huy', username: 'huy', password: '1234', role: 'viewer', name: 'Huy Sale' }
                ];
                for (const u of defaultUsers) {
                    await window.setDoc(window.doc(window.db, "users", u.id), u);
                }
            }
            // Enable login button after initial check
            document.getElementById('loading-msg').classList.add('hidden');
        }

        // --- AUTH SYSTEM ---
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const userIn = document.getElementById('login-username').value.trim();
            const passIn = document.getElementById('login-password').value.trim();
            
            if (state.users.length === 0) {
                document.getElementById('loading-msg').classList.remove('hidden');
                return;
            }

            const user = state.users.find(u => 
                u.username.toLowerCase() === userIn.toLowerCase() && u.password === passIn
            );

            if (user) {
                state.currentUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('login-error').classList.add('hidden');
                showToast(`Xin ch√†o ${user.name}!`, 'success');
                renderApp();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        });

        function logout() {
            state.currentUser = null;
            document.getElementById('app-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
        }

        // --- RENDER LOGIC ---
        function renderApp() {
            if (!state.currentUser) return;
            const isAdmin = state.currentUser.role === 'admin';

            // Header
            document.getElementById('user-name-display').textContent = state.currentUser.name;
            const roleBadge = document.getElementById('user-role-badge');
            roleBadge.textContent = isAdmin ? 'ADMIN' : 'VIEWER';
            roleBadge.className = `text-[10px] font-bold px-1.5 py-0.5 rounded uppercase text-white ${isAdmin ? 'bg-rose-500' : 'bg-blue-500'}`;

            // Visibility
            const adminEls = ['admin-controls', 'admin-list-container', 'admin-stats-container', 'admin-header-controls'];
            const viewerEls = ['viewer-placeholder', 'viewer-list-placeholder', 'viewer-stats-container', 'viewer-settings-btn'];

            if (isAdmin) {
                adminEls.forEach(id => document.getElementById(id).classList.remove('hidden'));
                viewerEls.forEach(id => document.getElementById(id).classList.add('hidden'));
                renderStats();
                renderAccounts();
            } else {
                adminEls.forEach(id => document.getElementById(id).classList.add('hidden'));
                viewerEls.forEach(id => document.getElementById(id).classList.remove('hidden'));
                renderViewerStats();
            }
        }

        function renderStats() {
            const total = state.accounts.length;
            const unsold = state.accounts.filter(a => a.status !== 'sold').length;
            const sold = state.accounts.filter(a => a.status === 'sold').length;
            const revenue = state.history.reduce((sum, h) => sum + h.price, 0);
            
            // Logic completed check
            const completed = state.accounts.filter(a => {
                if (a.status === 'sold') return false;
                if (a.status === 'completed') return true;
                if (a.status === 'farming' && a.mode === 'auto' && a.farmingStartedAt) {
                    const days = (Date.now() - a.farmingStartedAt) / (1000 * 60 * 60 * 24);
                    return days >= 23;
                }
                return false;
            }).length;

            document.getElementById('ready-count-badge').textContent = `${completed} Acc s·∫µn`;

            const cardBg = state.isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-transparent';
            const items = [
                { t: 'T·ªïng Acc', v: total, c: 'text-slate-500', i: 'ph-stack' },
                { t: 'Ch∆∞a b√°n', v: unsold, c: 'text-indigo-500', i: 'ph-bag', b: 'bg-indigo-900/20' },
                { t: 'ƒê√£ b√°n', v: sold, c: 'text-emerald-500', i: 'ph-currency-dollar', b: 'bg-emerald-900/20' },
                { t: 'Doanh thu', v: revenue.toLocaleString(), c: 'text-emerald-500', i: 'ph-trend-up', b: 'bg-emerald-900/20' },
                { t: 'S·∫Øp xong', v: 0, c: 'text-rose-500', i: 'ph-lightning', b: 'bg-rose-900/20' },
                { t: 'Ho√†n th√†nh', v: completed, c: 'text-blue-500', i: 'ph-check-circle', b: 'bg-blue-900/20' },
            ];

            const html = items.map(x => `
                <div class="${x.b || 'bg-transparent'} ${cardBg} border rounded-2xl p-4 transition-all shadow-sm">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-bold uppercase tracking-wider ${state.isDark ? 'text-slate-500' : 'text-slate-400'}">${x.t}</span>
                        <i class="ph ${x.i} ${x.c}"></i>
                    </div>
                    <span class="text-2xl font-bold ${x.c}">${x.v}</span>
                </div>
            `).join('');
            document.getElementById('admin-stats-container').innerHTML = html;
        }

        function renderViewerStats() {
            const userId = state.currentUser.id;
            const userSales = state.history.filter(h => h.soldBy === userId);
            const count = userSales.length;
            const totalCommission = userSales.reduce((sum, item) => sum + (item.commission || 0), 0);
            
            // Commission logic:
            // 0-19: 2%
            // 20-49: 5%
            // 50+: 7%
            let currentRate = 0.02;
            let nextTierText = `C·∫ßn ${20 - count} acc ƒë·ªÉ l√™n 5%`;
            let progress = (count / 20) * 100;

            if (count >= 50) {
                currentRate = 0.07;
                nextTierText = "Max Level (7%)";
                progress = 100;
            } else if (count >= 20) {
                currentRate = 0.05;
                nextTierText = `C·∫ßn ${50 - count} acc ƒë·ªÉ l√™n 7%`;
                // Progress within 20-50 range (size 30)
                progress = ((count - 20) / 30) * 100;
            }

            const boxClass = state.isDark ? 'bg-slate-800 border-slate-700' : 'bg-slate-50 border-slate-200';

            document.getElementById('viewer-stats-container').innerHTML = `
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="ph ph-briefcase text-indigo-500"></i> Hi·ªáu su·∫•t c√° nh√¢n</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-4 rounded-xl border ${boxClass}">
                        <div class="text-sm font-bold text-slate-500 mb-1">C·∫•p ƒë·ªô hi·ªán t·∫°i</div>
                        <div class="text-3xl font-bold text-purple-500">${(currentRate * 100).toFixed(0)}% <span class="text-sm text-slate-500">Hoa h·ªìng</span></div>
                        <div class="mt-2 w-full bg-slate-700 h-1.5 rounded-full overflow-hidden">
                            <div class="bg-purple-500 h-full" style="width: ${progress}%"></div>
                        </div>
                        <div class="text-[10px] mt-1 text-slate-500 text-right">${nextTierText}</div>
                    </div>
                    <div class="p-4 rounded-xl border ${boxClass}">
                        <div class="text-sm font-bold text-slate-500 mb-1">S·ªë l∆∞·ª£ng ƒë√£ b√°n</div>
                        <div class="text-3xl font-bold text-blue-500">${count} <span class="text-sm text-slate-500">Acc</span></div>
                    </div>
                    <div class="p-4 rounded-xl border ${boxClass}">
                        <div class="text-sm font-bold text-slate-500 mb-1">T·ªïng ti·ªÅn nh·∫≠n ƒë∆∞·ª£c</div>
                        <div class="text-3xl font-bold text-emerald-500">${totalCommission.toLocaleString()} <span class="text-sm text-slate-500">VNƒê</span></div>
                    </div>
                </div>
            `;
        }

        // --- ACCOUNT LIST & SEARCH ---
        function setFilter(f) {
            state.filter = f;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const isActive = btn.dataset.filter === f;
                btn.className = `filter-btn px-3 py-1.5 rounded-md text-xs font-bold capitalize transition-all whitespace-nowrap ${isActive ? 'bg-slate-700 text-amber-500 shadow' : 'text-slate-400 hover:text-slate-200'}`;
            });
            renderAccounts();
        }

        function handleSearch(val) {
            state.searchQuery = val.trim().toLowerCase();
            renderAccounts();
        }

        function renderAccounts() {
            const now = Date.now();
            
            // FILTER & SEARCH LOGIC
            const filtered = state.accounts.filter(acc => {
                // 1. Status Filter
                let statusMatch = true;
                if (state.filter !== 'all') {
                    statusMatch = getAccStatus(acc) === state.filter;
                }

                // 2. Search Filter
                let searchMatch = true;
                if (state.searchQuery) {
                    const u = acc.username ? acc.username.toLowerCase() : '';
                    const n = acc.note ? acc.note.toLowerCase() : '';
                    searchMatch = u.includes(state.searchQuery) || n.includes(state.searchQuery);
                }

                return statusMatch && searchMatch;
            });

            document.getElementById('list-count-badge').textContent = filtered.length;
            const listEl = document.getElementById('accounts-list');

            if (filtered.length === 0) {
                const emptyMsg = state.searchQuery ? `Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ cho "${state.searchQuery}"` : 'Tr·ªëng';
                listEl.innerHTML = `<div class="h-full flex flex-col items-center justify-center opacity-60 text-slate-500"><i class="ph ph-magnifying-glass text-6xl mb-4 opacity-50"></i><p>${emptyMsg}</p></div>`;
                return;
            }

            listEl.innerHTML = filtered.map((acc, idx) => {
                // Logic Days
                let status = acc.status;
                let effectiveDays = acc.daysFarmed || 0;
                let timeLabel = '';
                let progress = 0;
                const mode = acc.mode || 'manual';

                if (mode === 'auto' && acc.farmingStartedAt && status !== 'sold') {
                    const elapsed = now - acc.farmingStartedAt;
                    const d = elapsed / (86400000);
                    effectiveDays = Math.floor(d);
                    if (effectiveDays >= 23) {
                        effectiveDays = 23; status = 'completed'; timeLabel = 'Xong';
                    } else {
                        status = 'farming';
                        const h = Math.floor((elapsed % 86400000)/3600000);
                        timeLabel = `${h}h`;
                    }
                }
                progress = Math.min((effectiveDays / 23) * 100, 100);

                // UI Helpers
                const isSold = status === 'sold';
                const isPending = status === 'pending';
                let stColor = isSold ? 'text-slate-500 border-slate-700 bg-slate-800' : (status==='completed'?'text-blue-400 border-blue-800 bg-blue-900/30' : (status==='farming'?'text-amber-400 border-amber-800 bg-amber-900/30' : 'text-slate-400 border-slate-700'));
                let stIcon = isSold ? 'ph-currency-dollar' : (status==='completed'?'ph-check-circle':(status==='farming'?'ph-lightning':'ph-clock'));
                let stText = isSold ? 'ƒê√É B√ÅN' : (status==='completed'?'HO√ÄN TH√ÄNH':(status==='farming'?'ƒêANG C√ÄY':'CH·ªú'));

                // Manual Days Controls (Admin Only)
                let manualControls = '';
                if (state.currentUser.role === 'admin' && !isSold && !isPending && mode === 'manual') {
                    manualControls = `
                        <div class="flex items-center gap-1 bg-slate-800/50 rounded p-0.5 border border-slate-700">
                            <button onclick="updateAccountDaysManual('${acc.id}', ${effectiveDays - 1})" class="p-1 hover:text-white hover:bg-slate-600 rounded"><i class="ph ph-minus"></i></button>
                            <span class="text-white min-w-[20px] text-center font-mono text-xs">${effectiveDays}</span>
                            <button onclick="updateAccountDaysManual('${acc.id}', ${effectiveDays + 1})" class="p-1 hover:text-white hover:bg-slate-600 rounded"><i class="ph ph-plus"></i></button>
                        </div>
                    `;
                } else if (!isSold && !isPending) {
                    // Auto or Viewer view
                    manualControls = `<div class="flex items-center gap-1.5 ${mode==='auto'?'text-blue-500 animate-pulse':'text-slate-500'}"><i class="ph ph-clock"></i><span>${effectiveDays} ng√†y ${timeLabel ? `(${timeLabel})` : ''}</span></div>`;
                }

                return `
                <div class="relative rounded-xl p-4 shadow-sm border bg-slate-900 border-slate-800 hover:border-slate-700 transition-all ${isSold ? 'opacity-60 grayscale' : ''}">
                    <div class="flex flex-col md:flex-row justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold border flex items-center gap-1 ${stColor}"><i class="ph ${stIcon}"></i> ${stText}</span>
                                <span class="text-xs font-bold text-slate-500">#${acc.id.slice(-4)}</span>
                            </div>
                            <div class="space-y-1 mb-2">
                                <div class="flex items-center gap-2 group/field cursor-pointer" onclick="copyToClipboard('${acc.username}', 'Username')">
                                    <h3 class="font-mono text-sm md:text-base font-bold truncate text-slate-200 max-w-[200px]">${acc.username}</h3>
                                    <i class="ph ph-copy text-slate-500 text-xs"></i>
                                </div>
                                <div class="flex items-center gap-2 group/field cursor-pointer" onclick="copyToClipboard('${acc.password}', 'Password')">
                                    <p class="font-mono text-xs truncate text-slate-500">Pass: ${acc.password}</p>
                                    <i class="ph ph-copy text-slate-600 text-xs"></i>
                                </div>
                            </div>
                            ${acc.note ? `<div class="text-xs px-2 py-1 rounded inline-block bg-slate-800 text-slate-400">${acc.note}</div>` : ''}
                        </div>
                        <div class="flex flex-col justify-between items-end gap-2">
                            <div class="flex items-center justify-end gap-2 group/price">
                                <span class="text-lg font-bold text-emerald-500">${acc.price.toLocaleString()} ƒë</span>
                                ${!isSold ? `<button onclick="editPrice('${acc.id}', ${acc.price})" class="opacity-0 group-hover/price:opacity-100 p-1 text-slate-500 hover:text-indigo-400 transition-opacity"><i class="ph ph-pencil-simple"></i></button>` : ''}
                            </div>
                            ${!isSold ? `
                                <button onclick="toggleAccountMode('${acc.id}', '${mode}')" class="text-[10px] px-2 py-1 rounded border ${mode==='auto'?'bg-blue-900/20 text-blue-400 border-blue-800':'bg-slate-800 text-slate-400 border-slate-700'}">
                                    ${mode==='auto'?'AUTO':'MANUAL'}
                                </button>
                                <div class="w-[140px] text-right">
                                    <div class="flex justify-end text-[10px] font-bold text-slate-500 mb-1 gap-2">
                                        ${manualControls}
                                        <span class="ml-1">${Math.round(progress)}%</span>
                                    </div>
                                    <div class="w-full h-1.5 rounded-full bg-slate-800"><div class="h-full rounded-full bg-blue-500 transition-all" style="width:${progress}%"></div></div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="mt-4 pt-3 border-t border-slate-800 flex gap-2">
                        <button onclick="copyAndStart('${acc.id}')" class="flex-1 py-2 px-3 rounded-lg text-sm font-bold flex items-center justify-center gap-2 ${isPending ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30' : 'bg-slate-800 text-slate-400'}">
                            <i class="ph ${isPending ? 'ph-play-circle' : 'ph-copy'}"></i> ${isPending ? 'Copy & Start' : 'Copy'}
                        </button>
                        ${!isSold ? `
                            <button onclick="requestSellSingle('${acc.id}')" class="p-2 rounded-lg bg-emerald-900/30 text-emerald-400"><i class="ph ph-currency-dollar"></i></button>
                            <button onclick="requestWipe('${acc.id}')" class="p-2 rounded-lg bg-orange-900/30 text-orange-400" title="Wipe Data"><i class="ph ph-eraser"></i></button>
                        ` : ''}
                        <button onclick="requestDelete('${acc.id}')" class="p-2 rounded-lg bg-rose-900/30 text-rose-400"><i class="ph ph-trash"></i></button>
                    </div>
                </div>
                `;
            }).join('');
        }

        // --- ACCOUNT ACTIONS (Using Firebase) ---
        async function handleAddAccount(e) {
            e.preventDefault();
            const u = document.getElementById('input-username').value;
            const p = document.getElementById('input-password').value;
            const price = document.getElementById('input-price').value;
            const note = document.getElementById('input-note').value;
            if (!u || !p) return;

            try {
                await window.addDoc(window.collection(window.db, "accounts"), {
                    username: u, password: p, price: Number(price) || 0, note,
                    daysFarmed: 0, status: 'pending', mode: 'manual', farmingStartedAt: null, soldBy: null, createdAt: Date.now()
                });
                document.getElementById('add-acc-form').reset();
                showToast('ƒê√£ th√™m Acc');
            } catch (err) { console.error(err); showToast('L·ªói th√™m Acc', 'error'); }
        }

        async function toggleAccountMode(id, currentMode) {
            const acc = state.accounts.find(a => a.id === id);
            const newMode = currentMode === 'manual' ? 'auto' : 'manual';
            let updates = { mode: newMode };
            
            if (newMode === 'auto') {
                const ms = (acc.daysFarmed || 0) * 86400000;
                updates.farmingStartedAt = Date.now() - ms;
                if (acc.status === 'pending') { updates.status = 'farming'; updates.farmingStartedAt = Date.now(); }
            } else {
                if (acc.farmingStartedAt) {
                    const d = (Date.now() - acc.farmingStartedAt) / 86400000;
                    updates.daysFarmed = Math.min(23, Math.floor(d));
                }
            }
            await window.updateDoc(window.doc(window.db, "accounts", id), updates);
        }

        async function updateAccountDaysManual(id, newDays) {
            const validDays = Math.max(0, Math.min(23, newDays));
            let status = 'farming';
            if (validDays >= 23) status = 'completed';
            if (validDays === 0) status = 'pending';
            
            await window.updateDoc(window.doc(window.db, "accounts", id), {
                daysFarmed: validDays,
                status: status
            });
        }
        
        // --- PRICE EDITING ---
        function editPrice(id, oldPrice) {
            const modal = document.getElementById('modal-content');
            modal.innerHTML = `
                <h3 class="font-bold text-lg mb-4">C·∫≠p nh·∫≠t gi√°</h3>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-400 mb-1">Gi√° m·ªõi (VNƒê)</label>
                    <input type="number" id="edit-price-input" value="${oldPrice}" class="w-full p-2 rounded bg-slate-800 border border-slate-700 focus:border-amber-500 outline-none text-white font-bold">
                </div>
                <div class="flex gap-2">
                    <button onclick="closeModal()" class="flex-1 py-2 rounded bg-slate-700 text-white font-bold">H·ªßy</button>
                    <button onclick="savePrice('${id}')" class="flex-1 py-2 rounded bg-emerald-600 text-white font-bold">L∆∞u</button>
                </div>
            `;
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('edit-price-input').focus();
        }

        async function savePrice(id) {
            const newPrice = Number(document.getElementById('edit-price-input').value);
            if (isNaN(newPrice) || newPrice < 0) return alert("Gi√° kh√¥ng h·ª£p l·ªá");
            
            try {
                await window.updateDoc(window.doc(window.db, "accounts", id), { price: newPrice });
                showToast('ƒê√£ c·∫≠p nh·∫≠t gi√°');
                closeModal();
            } catch (e) {
                console.error(e);
                showToast('L·ªói khi c·∫≠p nh·∫≠t', 'error');
            }
        }

        async function copyAndStart(id) {
            const acc = state.accounts.find(a => a.id === id);
            copyToClipboard(`${acc.username}|${acc.password}`, "User|Pass");
            if (acc.status === 'pending') {
                await window.updateDoc(window.doc(window.db, "accounts", id), {
                    status: 'farming', daysFarmed: 1, mode: 'auto', farmingStartedAt: Date.now()
                });
            }
        }

        function requestDelete(id) {
            showConfirmModal('X√°c nh·∫≠n x√≥a', 'B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a?', async () => {
                await window.deleteDoc(window.doc(window.db, "accounts", id));
                showToast('ƒê√£ x√≥a Acc', 'error');
                closeModal();
            });
        }
        
        // --- WIPE DATA LOGIC ---
        function requestWipe(id) {
             showConfirmModal('Wipe Data Acc', 'B·∫°n mu·ªën reset ti·∫øn tr√¨nh c√†y c·ªßa acc n√†y? (User/Pass v·∫´n gi·ªØ nguy√™n)', async () => {
                await performWipe(id);
                closeModal();
            });
        }

        async function performWipe(id) {
            try {
                // Reset status to pending, days to 0, mode manual
                await window.updateDoc(window.doc(window.db, "accounts", id), {
                    status: 'pending',
                    daysFarmed: 0,
                    mode: 'manual',
                    farmingStartedAt: null,
                    // We keep username, password, price, note, createdAt
                });
                showToast('ƒê√£ Wipe Data th√†nh c√¥ng');
            } catch(e) {
                console.error(e);
                showToast('L·ªói Wipe Data', 'error');
            }
        }

        // --- SELLING LOGIC (Corrected Select Seller) ---
        function requestSellSingle(id) {
            showConfirmModal('B√°n Account', 'Ch·ªçn ng∆∞·ªùi b√°n t√≠nh doanh thu:', async () => {
                const sellerId = document.getElementById('seller-select').value;
                await performSellSingle(id, sellerId);
                closeModal();
            }, true);
        }

        async function performSellSingle(accId, sellerId) {
            const acc = state.accounts.find(a => a.id === accId);
            if (!acc) return;

            // Logic Commission Update
            const sellerHistory = state.history.filter(h => h.soldBy === sellerId);
            const isViewer = state.users.find(u => u.id === sellerId)?.role === 'viewer';
            let comm = 0;
            if (isViewer) {
                const count = sellerHistory.length;
                const rate = getCommissionRate(count);
                comm = acc.price * rate;
            }

            // Calc final days
            let finalDays = acc.daysFarmed;
            if (acc.mode === 'auto' && acc.farmingStartedAt) {
                finalDays = Math.floor((Date.now() - acc.farmingStartedAt) / 86400000);
            }

            // Update DB
            const batch = {
                ...acc, daysFarmed: Math.min(23, finalDays),
                soldAt: Date.now(), soldMethod: 'manual', soldBy: sellerId, commission: comm
            };
            
            // Add History & Update Account parallel
            await window.addDoc(window.collection(window.db, "history"), batch);
            await window.updateDoc(window.doc(window.db, "accounts", accId), { status: 'sold', soldBy: sellerId });
            
            showSoldModal('single', 1, acc.price, acc);
        }

        function requestSellRandom() {
            const qty = parseInt(document.getElementById('sell-qty-input').value) || 1;
            const getD = (a) => a.mode === 'auto' && a.farmingStartedAt ? Math.floor((Date.now()-a.farmingStartedAt)/86400000) : a.daysFarmed;
            const ready = state.accounts.filter(a => (a.status === 'completed' || (a.status === 'farming' && getD(a) >= 23)) && a.status !== 'sold');

            if (ready.length === 0) return showToast('Ch∆∞a c√≥ acc ƒë·ªß ng√†y!', 'error');

            const count = Math.min(qty, ready.length);
            showConfirmModal(`B√°n Random ${count} Acc`, `T√¨m th·∫•y ${ready.length} acc ok. Ch·ªçn ng∆∞·ªùi b√°n:`, async () => {
                const sellerId = document.getElementById('seller-select').value;
                await performSellRandom(ready, count, sellerId);
                closeModal();
            }, true);
        }

        async function performSellRandom(readyAccs, count, sellerId) {
            // Shuffle
            const selected = [...readyAccs].sort(()=>0.5-Math.random()).slice(0, count);
            const sellerHistLen = state.history.filter(h => h.soldBy === sellerId).length;
            const isViewer = state.users.find(u => u.id === sellerId)?.role === 'viewer';

            let revenue = 0;
            // Process Loop
            for (let i = 0; i < selected.length; i++) {
                const acc = selected[i];
                let comm = 0;
                if (isViewer) {
                    const currentCount = sellerHistLen + i;
                    const rate = getCommissionRate(currentCount);
                    comm = acc.price * rate;
                }
                
                let finalDays = acc.daysFarmed;
                if (acc.mode === 'auto' && acc.farmingStartedAt) finalDays = Math.floor((Date.now() - acc.farmingStartedAt)/86400000);

                const hItem = {
                    ...acc, daysFarmed: Math.min(23, finalDays),
                    soldAt: Date.now(), soldMethod: 'random', soldBy: sellerId, commission: comm
                };
                
                await window.addDoc(window.collection(window.db, "history"), hItem);
                await window.updateDoc(window.doc(window.db, "accounts", acc.id), { status: 'sold', soldBy: sellerId });
                revenue += acc.price;
            }
            showSoldModal('batch', count, revenue);
        }

        // --- USER MANAGEMENT & EDITING ---
        function showUserManageModal() {
            const userHtml = state.users.map(u => {
                // Calculate Revenue for Viewer
                let revHtml = '';
                if (u.role === 'viewer') {
                    const rev = state.history.filter(h => h.soldBy === u.id).reduce((s, h) => s + h.price, 0);
                    revHtml = `<div class="mt-2 pt-2 border-t border-slate-700 flex justify-between text-xs text-emerald-400 font-bold"><span>Doanh thu:</span><span>${rev.toLocaleString()} ƒë</span></div>`;
                }

                return `
                <div class="p-3 rounded-xl border border-slate-700 bg-slate-800 mb-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold">${u.name} <span class="text-xs text-slate-500">(${u.role})</span></div>
                            <div class="text-xs font-mono text-slate-400">User: ${u.username}</div>
                        </div>
                        <button onclick="editUser('${u.id}')" class="text-indigo-400 p-1"><i class="ph ph-pencil-simple"></i></button>
                    </div>
                    ${revHtml}
                </div>`;
            }).join('');

            const modal = document.getElementById('modal-content');
            modal.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">Qu·∫£n l√Ω User</h3>
                    <button onclick="closeModal()"><i class="ph ph-x text-xl"></i></button>
                </div>
                <div class="max-h-[400px] overflow-y-auto mb-4">${userHtml}</div>
                <button onclick="addNewUserPrompt()" class="w-full py-2 rounded-lg bg-indigo-600 text-white font-bold text-sm">Th√™m User M·ªõi</button>
            `;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        // Edit User (Admin)
        function editUser(uid) {
            const u = state.users.find(x => x.id === uid);
            const modal = document.getElementById('modal-content');
            modal.innerHTML = `
                <h3 class="font-bold text-lg mb-4">S·ª≠a User: ${u.name}</h3>
                <div class="space-y-3">
                    <div><label class="text-xs text-slate-400">T√™n hi·ªÉn th·ªã</label><input id="edit-name" value="${u.name}" class="w-full p-2 rounded bg-slate-800 border border-slate-700"></div>
                    <div><label class="text-xs text-slate-400">Username</label><input id="edit-user" value="${u.username}" class="w-full p-2 rounded bg-slate-800 border border-slate-700"></div>
                    <div><label class="text-xs text-slate-400">Password</label><input id="edit-pass" value="${u.password}" class="w-full p-2 rounded bg-slate-800 border border-slate-700"></div>
                </div>
                <button onclick="saveUserEdit('${uid}')" class="w-full mt-4 py-2 rounded-lg bg-green-600 text-white font-bold">L∆∞u Thay ƒê·ªïi</button>
            `;
        }

        async function saveUserEdit(uid) {
            const name = document.getElementById('edit-name').value;
            const username = document.getElementById('edit-user').value;
            const password = document.getElementById('edit-pass').value;
            await window.updateDoc(window.doc(window.db, "users", uid), { name, username, password });
            showToast('ƒê√£ c·∫≠p nh·∫≠t User');
            showUserManageModal(); // Back to list
        }

        // Viewer Settings (Name & Pass) - UPDATED
        function showViewerSettingsModal() {
            const u = state.currentUser;
            const modal = document.getElementById('modal-content');
            modal.innerHTML = `
                <h3 class="font-bold text-lg mb-4">C√†i ƒê·∫∑t C√° Nh√¢n</h3>
                <div class="space-y-3">
                     <div><label class="text-xs text-slate-400">T√™n Hi·ªÉn Th·ªã</label><input id="my-name" type="text" value="${u.name}" class="w-full p-2 rounded bg-slate-800 border border-slate-700"></div>
                    <div><label class="text-xs text-slate-400">Password M·ªõi</label><input id="new-pass" type="text" value="${u.password}" class="w-full p-2 rounded bg-slate-800 border border-slate-700"></div>
                </div>
                <button onclick="saveMyProfile('${u.id}')" class="w-full mt-4 py-2 rounded-lg bg-green-600 text-white font-bold">L∆∞u Thay ƒê·ªïi</button>
                <button onclick="closeModal()" class="w-full mt-2 py-2 rounded-lg bg-slate-700 text-white font-bold">H·ªßy</button>
            `;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        async function saveMyProfile(uid) {
            const name = document.getElementById('my-name').value;
            const password = document.getElementById('new-pass').value;
            await window.updateDoc(window.doc(window.db, "users", uid), { name, password });
            showToast('ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin');
            closeModal();
        }

        async function addNewUserPrompt() {
            const id = prompt("Nh·∫≠p ID (v√≠ d·ª•: nam_sale):");
            if(!id) return;
            // Check exist
            if(state.users.find(u=>u.id===id)) return alert("ID ƒë√£ t·ªìn t·∫°i");
            
            await window.setDoc(window.doc(window.db, "users", id), {
                id, username: id, password: '123', name: id, role: 'viewer'
            });
            showToast("ƒê√£ th√™m user m·ªõi (Pass: 123)");
            showUserManageModal();
        }

        // --- UTILS & MODALS ---
        function showConfirmModal(title, msg, onConfirm, showSeller=false) {
            let sellerHtml = '';
            if (showSeller) {
                const opts = state.users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
                sellerHtml = `<div class="mb-4 text-left"><label class="text-xs font-bold text-slate-400">Ng∆∞·ªùi b√°n:</label><select id="seller-select" class="w-full p-2 rounded bg-slate-800 border-slate-700">${opts}</select></div>`;
            }
            document.getElementById('modal-content').innerHTML = `
                <h3 class="font-bold text-xl mb-2 text-center">${title}</h3><p class="text-center text-slate-400 mb-4">${msg}</p>
                ${sellerHtml}
                <div class="flex gap-2"><button onclick="closeModal()" class="flex-1 py-2 rounded bg-slate-700">H·ªßy</button><button id="confirm-btn" class="flex-1 py-2 rounded bg-amber-600 text-white font-bold">OK</button></div>
            `;
            document.getElementById('confirm-btn').onclick = onConfirm;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function showSoldModal(type, count, rev, acc=null) {
             let body = type === 'batch' 
                ? `<div class="p-4 rounded-xl bg-slate-950 border border-slate-800 text-center"><p class="text-2xl font-bold text-emerald-500">+${rev.toLocaleString()} ƒë</p></div>`
                : `<div class="p-4 rounded-xl bg-slate-950 border border-slate-800 text-left">
                     <button onclick="copyToClipboard('${acc.username}|${acc.password}','User|Pass')" class="w-full p-2 bg-indigo-900/30 text-indigo-400 font-mono text-sm truncate mb-2">${acc.username}|${acc.password}</button>
                     <div class="flex justify-between border-t border-slate-800 pt-2"><span class="text-xs">Gi√° b√°n</span><span class="font-bold text-emerald-500">${rev.toLocaleString()} ƒë</span></div>
                   </div>`;

             document.getElementById('modal-content').innerHTML = `
                <div class="text-center mb-4"><div class="inline-flex p-3 rounded-full bg-green-900/30 text-green-500 mb-2"><i class="ph ph-check-circle text-3xl"></i></div><h3 class="text-xl font-bold">Th√†nh C√¥ng!</h3></div>
                ${body}
                <button onclick="closeModal()" class="absolute top-4 right-4"><i class="ph ph-x"></i></button>
             `;
             document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function showHistoryModal() {
            const html = state.history.map(h => `
                <div class="p-3 rounded-xl border border-slate-700 bg-slate-800 mb-2 flex justify-between items-center">
                    <div>
                        <div class="flex items-center gap-2"><span class="text-[10px] bg-slate-700 px-1 rounded uppercase">${h.soldMethod}</span><span class="font-bold text-sm text-slate-300">${h.username}</span></div>
                        <div class="text-xs text-slate-500">Seller: ${state.users.find(u=>u.id===h.soldBy)?.name || h.soldBy}</div>
                    </div>
                    <div class="text-right"><div class="font-bold text-emerald-500">+${h.price.toLocaleString()}</div><div class="text-[10px] text-slate-500">${new Date(h.soldAt).toLocaleDateString()}</div></div>
                </div>
            `).join('');
            document.getElementById('large-modal-content').innerHTML = `
                <div class="p-4 border-b border-slate-700 flex justify-between"><h3 class="font-bold">L·ªãch S·ª≠</h3><button onclick="document.getElementById('large-modal-overlay').classList.add('hidden')"><i class="ph ph-x text-xl"></i></button></div>
                <div class="p-4 overflow-y-auto h-full">${html || '<p class="text-center text-slate-500">Tr·ªëng</p>'}</div>
            `;
            document.getElementById('large-modal-overlay').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); }
        
        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            
            // Icon
            const icon = document.getElementById('toast-icon');
            icon.className = type === 'error' ? 'ph ph-warning-circle text-4xl mb-1 text-rose-300' : 'ph ph-check-circle text-4xl mb-1 text-emerald-300';
            
            // Background
            t.className = `fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[100] px-8 py-6 rounded-2xl shadow-2xl flex flex-col items-center justify-center gap-2 font-bold text-white transition-all duration-300 min-w-[240px] text-center border ${type==='error'?'bg-rose-900/90 border-rose-700 shadow-rose-900/50':'bg-emerald-900/90 border-emerald-700 shadow-emerald-900/50'} backdrop-blur-md opacity-100 scale-100 visible`;
            
            setTimeout(() => {
                t.className = `fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[100] px-8 py-6 rounded-2xl shadow-2xl flex flex-col items-center justify-center gap-2 font-bold text-white transition-all duration-300 min-w-[240px] text-center opacity-0 scale-90 invisible`;
            }, 2500);
        }
        
        function copyToClipboard(txt, lbl) {
            navigator.clipboard.writeText(txt).then(() => showToast(`ƒê√£ copy ${lbl}`));
        }
        function getAccStatus(acc) {
            if(acc.status==='sold') return 'sold';
            if(acc.status==='completed') return 'completed';
            if(acc.status==='farming' && acc.mode==='auto' && acc.farmingStartedAt) {
                if((Date.now()-acc.farmingStartedAt)/86400000 >= 23) return 'completed';
            }
            return acc.status;
        }
        function generateHotmail() {
            const u = Math.random().toString(36).substring(2,10);
            const p = Math.random().toString(36).substring(2,12).toUpperCase() + '!';
            document.getElementById('gen-email').textContent = u + '@hotmail.com';
            document.getElementById('gen-pass').textContent = p;
            document.getElementById('btn-fill-form').disabled = false;
            document.getElementById('btn-fill-form').classList.remove('opacity-50','cursor-not-allowed');
        }
        function fillForm() {
            document.getElementById('input-username').value = document.getElementById('gen-email').textContent;
            document.getElementById('input-password').value = document.getElementById('gen-pass').textContent;
        }
        function adjustSellQty(v) {
            const el = document.getElementById('sell-qty-input');
            el.value = Math.max(1, parseInt(el.value)+v);
        }
        function toggleTheme() {
            state.isDark = !state.isDark;
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', state.isDark ? 'dark' : 'light');
            updateThemeIcon();
            renderApp();
        }
        function updateThemeIcon() {
            document.getElementById('theme-icon').className = state.isDark ? 'ph ph-sun text-xl' : 'ph ph-moon text-xl';
        }
    </script>
</body>
</html>


