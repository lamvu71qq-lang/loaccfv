!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BearAcc Pro</title>
    <!-- Teddy Bear Icon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß∏</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, setDoc, getDocs, getDoc, where, writeBatch 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBXY_kuplXAslH11t4rLRVo0-kyqmt4m3E",
          authDomain: "lo-acc-fv.firebaseapp.com",
          projectId: "lo-acc-fv",
          storageBucket: "lo-acc-fv.firebasestorage.app",
          messagingSenderId: "757484054386",
          appId: "1:757484054386:web:a4d7825732c72183ec9feb",
          measurementId: "G-372P84L4GG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Expose DB functions to global window
        window.db = db;
        window.collection = collection;
        window.doc = doc;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.setDoc = setDoc;
        window.getDocs = getDocs;
        window.getDoc = getDoc;
        window.where = where;
        window.writeBatch = writeBatch;

        signInAnonymously(auth).then(() => {
            console.log("Connected to Firebase");
            window.initApp();
        }).catch((error) => {
            console.error("Firebase Auth Error", error);
            alert("L·ªói k·∫øt n·ªëi Server! Vui l√≤ng reload.");
        });
    </script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                    mono: ['JetBrains Mono', 'monospace'],
                },
                extend: {
                    animation: {
                        'slide-in': 'slideIn 0.4s ease-out forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                        'scale-in': 'scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                    },
                    keyframes: {
                        slideIn: {
                            'from': { opacity: '0', transform: 'translateY(20px)' },
                            'to': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            'from': { opacity: '0' },
                            'to': { opacity: '1' },
                        },
                        scaleIn: {
                            'from': { transform: 'scale(0.9)', opacity: '0' },
                            'to': { transform: 'scale(1)', opacity: '1' },
                        },
                        popIn: {
                            'from': { opacity: '0', transform: 'translate(-50%, -40%) scale(0.9)' },
                            'to': { opacity: '1', transform: 'translate(-50%, -50%) scale(1)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .dark ::-webkit-scrollbar { width: 8px; }
        .dark ::-webkit-scrollbar-track { background: #0f172a; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #475569; }
        body { transition: background-color 0.3s, color 0.3s; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen font-sans pb-20">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md p-8 rounded-2xl shadow-2xl border bg-slate-900 border-slate-800 animate-scale-in">
            <div class="flex flex-col items-center mb-6">
                <!-- Teddy Bear Icon -->
                <div class="bg-amber-600 p-4 rounded-full mb-4 shadow-lg shadow-amber-500/30">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M224,96a56.06,56.06,0,0,0-56-56,8,8,0,0,0-8,8,40,40,0,0,1-80,0,8,8,0,0,0-8-8,56.06,56.06,0,0,0-56,56,8,8,0,0,0,8,8,40,40,0,0,1,33.84,18.78,56.12,56.12,0,0,0,84.32,0A40,40,0,0,1,176,104,8,8,0,0,0,224,96ZM48,96a40,40,0,0,1,28.62-38.34A56,56,0,0,0,32,96c0,13.23,7.26,24.83,18.09,31.72A40.16,40.16,0,0,1,48,96Zm174.12,32.3A56.1,56.1,0,0,0,186,171.18c4.37,8.22,6.58,16.59,6,24.23-.74,9.65-6.69,17-15.65,19.33a54.54,54.54,0,0,1-13.67,1.72c-9.1,0-19.36-2.58-29.07-7.29a8,8,0,0,0-7.22,0c-9.71,4.71-20,7.29-29.07,7.29a54.54,54.54,0,0,1-13.67-1.72c-9-2.31-14.91-9.68-15.65-19.33-.55-7.64,1.66-16,6-24.23a56,56,0,0,0,0-85.36c.7-1.32,1.44-2.61,2.22-3.86a56,56,0,0,0,145.87,49.22ZM92,152a12,12,0,1,1,12-12A12,12,0,0,1,92,152Zm72,0a12,12,0,1,1,12-12A12,12,0,0,1,164,152Z"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-amber-500">BearAcc Pro</h1>
                <p class="text-slate-400 flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Firebase Live Sync</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold uppercase mb-1.5 opacity-70">Username</label>
                    <input type="text" id="login-username" class="w-full px-4 py-3 rounded-xl outline-none border-2 bg-slate-800 border-slate-700 focus:border-amber-500 transition-colors placeholder-slate-500" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" autofocus>
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase mb-1.5 opacity-70">Password</label>
                    <input type="password" id="login-password" class="w-full px-4 py-3 rounded-xl outline-none border-2 bg-slate-800 border-slate-700 focus:border-amber-500 transition-colors placeholder-slate-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div id="login-error" class="hidden p-3 rounded-lg bg-rose-500/10 text-rose-500 text-sm font-bold flex items-center gap-2">
                    <i class="ph ph-warning-circle"></i> <span>Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u!</span>
                </div>
                <div id="loading-msg" class="hidden text-center text-amber-400 font-bold text-sm animate-pulse">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ server...</div>
                <button type="submit" id="btn-login" class="w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-amber-500/30 active:scale-95">ƒêƒÉng Nh·∫≠p</button>
            </form>
        </div>
    </div>

    <!-- APP SCREEN -->
    <div id="app-screen" class="hidden">
        <header class="backdrop-blur-md sticky top-0 z-50 border-b shadow-sm transition-colors duration-300 bg-slate-900/80 border-slate-800">
            <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-amber-600 p-1.5 rounded-lg text-white shadow-lg shadow-amber-500/30">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M224,96a56.06,56.06,0,0,0-56-56,8,8,0,0,0-8,8,40,40,0,0,1-80,0,8,8,0,0,0-8-8,56.06,56.06,0,0,0-56,56,8,8,0,0,0,8,8,40,40,0,0,1,33.84,18.78,56.12,56.12,0,0,0,84.32,0A40,40,0,0,1,176,104,8,8,0,0,0,224,96ZM48,96a40,40,0,0,1,28.62-38.34A56,56,0,0,0,32,96c0,13.23,7.26,24.83,18.09,31.72A40.16,40.16,0,0,1,48,96Zm174.12,32.3A56.1,56.1,0,0,0,186,171.18c4.37,8.22,6.58,16.59,6,24.23-.74,9.65-6.69,17-15.65,19.33a54.54,54.54,0,0,1-13.67,1.72c-9.1,0-19.36-2.58-29.07-7.29a8,8,0,0,0-7.22,0c-9.71,4.71-20,7.29-29.07,7.29a54.54,54.54,0,0,1-13.67-1.72c-9-2.31-14.91-9.68-15.65-19.33-.55-7.64,1.66-16,6-24.23a56,56,0,0,0,0-85.36c.7-1.32,1.44-2.61,2.22-3.86a56,56,0,0,0,145.87,49.22ZM92,152a12,12,0,1,1,12-12A12,12,0,0,1,92,152Zm72,0a12,12,0,1,1,12-12A12,12,0,0,1,164,152Z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold leading-none text-amber-500">BearAcc Pro</h1>
                        <div class="flex items-center gap-2 mt-1">
                            <span id="user-role-badge" class="text-[10px] font-bold px-1.5 py-0.5 rounded uppercase bg-rose-500 text-white">ADMIN</span>
                            <span id="user-name-display" class="text-xs font-medium text-slate-400">User</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2 md:gap-3">
                    <div id="admin-header-controls" class="flex gap-2">
                        <button onclick="showWipeSystemModal()" class="p-2.5 rounded-full transition-all flex items-center gap-2 bg-slate-800 text-rose-500 hover:bg-slate-700 hover:text-rose-400" title="Wipe System Data"><i class="ph ph-trash text-xl"></i></button>
                        <button onclick="showUserManageModal()" class="p-2.5 rounded-full transition-all flex items-center gap-2 bg-slate-800 text-purple-400 hover:bg-slate-700" title="Qu·∫£n l√Ω Users"><i class="ph ph-user-gear text-xl"></i></button>
                        <button onclick="showHistoryModal()" class="p-2.5 rounded-full transition-all flex items-center gap-2 bg-slate-800 text-blue-400 hover:bg-slate-700" title="L·ªãch s·ª≠ giao d·ªãch"><i class="ph ph-clock-counter-clockwise text-xl"></i></button>
                    </div>
                    <!-- Settings for Viewer -->
                    <button id="viewer-settings-btn" onclick="showViewerSettingsModal()" class="hidden p-2.5 rounded-full transition-all bg-slate-800 text-indigo-400 hover:bg-slate-700" title="C√†i ƒë·∫∑t c√° nh√¢n">
                        <i class="ph ph-gear text-xl"></i>
                    </button>
                    <button onclick="toggleTheme()" class="p-2.5 rounded-full transition-all bg-slate-800 text-yellow-400 hover:bg-slate-700">
                        <i id="theme-icon" class="ph ph-sun text-xl"></i>
                    </button>
                    <button onclick="logout()" class="p-2.5 rounded-full transition-all bg-slate-800 text-rose-400 hover:bg-slate-700" title="ƒêƒÉng xu·∫•t">
                        <i class="ph ph-sign-out text-xl"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-4 md:p-6 space-y-8">
            <!-- VIEWER STATS -->
            <div id="viewer-stats-container" class="hidden p-6 rounded-2xl border bg-slate-900 border-slate-800 shadow-lg mb-8"></div>
            
            <!-- ADMIN STATS -->
            <section id="admin-stats-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4"></section>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- SIDEBAR -->
                <div class="lg:col-span-4 space-y-6">
                    <div id="admin-controls" class="space-y-6">
                        <!-- SELL RANDOM -->
                        <div class="rounded-2xl p-6 shadow-sm border relative overflow-hidden group bg-gradient-to-br from-slate-900 to-purple-900/20 border-purple-500/30">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="font-bold text-lg flex items-center gap-2 text-white"><i class="ph ph-shuffle text-purple-500 text-xl"></i> B√°n Random</h2>
                                <span id="ready-count-badge" class="text-xs bg-purple-500 text-white px-2 py-0.5 rounded-full font-bold">0 Acc s·∫µn</span>
                            </div>
                            <div class="mb-4">
                                <label class="text-[10px] font-bold uppercase opacity-70 mb-1 block">S·ªë l∆∞·ª£ng b√°n</label>
                                <div class="flex items-center gap-2">
                                    <button onclick="adjustSellQty(-1)" class="p-2 rounded border bg-slate-800 border-slate-700 hover:bg-slate-700"><i class="ph ph-minus"></i></button>
                                    <input type="number" id="sell-qty-input" value="1" class="w-full text-center p-2 rounded border font-bold bg-slate-800 border-slate-700 outline-none" min="1">
                                    <button onclick="adjustSellQty(1)" class="p-2 rounded border bg-slate-800 border-slate-700 hover:bg-slate-700"><i class="ph ph-plus"></i></button>
                                </div>
                            </div>
                            <button onclick="requestSellRandom()" class="w-full py-3 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-bold shadow-lg shadow-purple-500/30 active:scale-95 transition-all flex justify-center items-center gap-2">
                                <i class="ph ph-currency-dollar text-xl"></i> B√°n Ngay
                            </button>
                        </div>

                        <!-- HOTMAIL GENERATOR -->
                        <div class="rounded-2xl p-6 shadow-sm transition-all bg-slate-900 border-slate-800 border hover:border-slate-700">
                            <div class="flex items-center gap-3 mb-5">
                                <div class="p-2 rounded-lg bg-blue-900/30 text-blue-400"><i class="ph ph-arrows-clockwise text-xl"></i></div>
                                <h2 class="font-bold text-lg">Hotmail Auto</h2>
                            </div>
                            <div class="space-y-4">
                                <div class="p-4 rounded-xl border border-dashed relative bg-slate-800 border-slate-700">
                                    <div class="space-y-2 font-mono text-sm">
                                        <div class="flex justify-between"><span class="text-slate-400">User:</span><span id="gen-email" class="font-semibold select-all text-white">---</span></div>
                                        <div class="flex justify-between"><span class="text-slate-400">Pass:</span><span id="gen-pass" class="font-semibold select-all text-white">---</span></div>
                                    </div>
                                </div>
                                <div class="flex gap-3">
                                    <button onclick="generateHotmail()" class="flex-1 py-2.5 rounded-xl font-medium transition-all active:scale-95 text-white bg-slate-700 hover:bg-slate-600">Random</button>
                                    <button id="btn-fill-form" onclick="fillForm()" disabled class="flex-1 border py-2.5 rounded-xl font-medium transition-all active:scale-95 flex justify-center items-center gap-2 bg-indigo-900/40 border-indigo-700 text-indigo-300 opacity-50 cursor-not-allowed">ƒêi·ªÅn <i class="ph ph-arrow-right"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- ADD ACCOUNT -->
                        <div class="rounded-2xl p-6 shadow-sm transition-all relative overflow-hidden bg-slate-900 border-slate-800 border hover:border-slate-700">
                            <div class="flex items-center gap-3 mb-5 relative z-10">
                                <div class="p-2 rounded-lg bg-emerald-900/30 text-emerald-400"><i class="ph ph-users text-xl"></i></div>
                                <h2 class="font-bold text-lg">Nh·∫≠p Li·ªáu</h2>
                            </div>
                            <form id="add-acc-form" onsubmit="handleAddAccount(event)" class="space-y-4 relative z-10">
                                <div class="space-y-3">
                                    <input type="text" id="input-username" class="w-full px-3 py-2.5 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none text-sm bg-slate-800 border-slate-700 placeholder-slate-500" placeholder="Email / Username">
                                    <input type="text" id="input-password" class="w-full px-3 py-2.5 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none text-sm bg-slate-800 border-slate-700 placeholder-slate-500" placeholder="Password">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="number" id="input-price" class="w-full px-3 py-2.5 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none text-sm bg-slate-800 border-slate-700 placeholder-slate-500" placeholder="Gi√° (VNƒê)">
                                    <input type="text" id="input-note" class="w-full px-3 py-2.5 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none text-sm bg-slate-800 border-slate-700 placeholder-slate-500" placeholder="Ghi ch√∫">
                                </div>
                                <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-emerald-500/20 transition-all active:scale-95 mt-2 flex justify-center items-center gap-2">
                                    <i class="ph ph-plus-circle text-lg"></i> Th√™m Acc
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- VIEWER PLACEHOLDER -->
                    <div id="viewer-placeholder" class="hidden h-full rounded-2xl p-8 flex flex-col items-center justify-center text-center opacity-60 border-2 border-dashed border-slate-800">
                        <i class="ph ph-shield-check text-5xl mb-4 text-slate-500"></i>
                        <h3 class="font-bold text-lg">Ch·∫ø ƒë·ªô Viewer</h3>
                        <p class="text-sm text-slate-400">Danh s√°ch t√†i kho·∫£n ƒë∆∞·ª£c ·∫©n.</p>
                    </div>
                </div>

                <!-- MAIN LIST -->
                <div class="lg:col-span-8 flex flex-col h-[800px] rounded-2xl shadow-lg overflow-hidden border bg-slate-900 border-slate-800">
                    <div id="admin-list-container" class="flex flex-col h-full">
                        <!-- HEADER AREA WITH SEARCH -->
                        <div class="p-4 border-b border-slate-800 bg-slate-900 space-y-3 z-10 sticky top-0">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                                <div class="flex items-center gap-2">
                                    <h2 class="font-bold text-lg">Kho Acc</h2>
                                    <span id="list-count-badge" class="px-2 py-0.5 rounded-md text-xs font-bold bg-slate-800 text-slate-400">0</span>
                                </div>
                                <!-- SEARCH BAR -->
                                <div class="relative w-full sm:w-64 group">
                                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 group-focus-within:text-amber-500 transition-colors"></i>
                                    <input type="text" id="search-input" oninput="handleSearch(this.value)" placeholder="T√¨m username, note..." class="w-full pl-9 pr-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-sm focus:border-amber-500 outline-none transition-all placeholder-slate-600 focus:bg-slate-950">
                                </div>
                            </div>
                            
                            <!-- FILTERS -->
                            <div class="flex p-1 rounded-lg overflow-x-auto max-w-full bg-slate-800 scrollbar-hide" id="filter-buttons">
                                <button onclick="setFilter('all')" class="filter-btn px-3 py-1.5 rounded-md text-xs font-bold capitalize bg-slate-700 text-amber-500 shadow" data-filter="all">T·∫•t c·∫£</button>
                                <button onclick="setFilter('pending')" class="filter-btn px-3 py-1.5 rounded-md text-xs font-bold capitalize text-slate-400 hover:text-slate-200" data-filter="pending">Ch·ªù</button>
                                <button onclick="setFilter('farming')" class="filter-btn px-3 py-1.5 rounded-md text-xs font-bold capitalize text-slate-400 hover:text-slate-200" data-filter="farming">ƒêang c√†y</button>
                                <button onclick="setFilter('completed')" class="filter-btn px-3 py-1.5 rounded-md text-xs font-bold capitalize text-slate-400 hover:text-slate-200" data-filter="completed">Xong</button>
                                <button onclick="setFilter('sold')" class="filter-btn px-3 py-1.5 rounded-md text-xs font-bold capitalize text-slate-400 hover:text-slate-200" data-filter="sold">ƒê√£ b√°n</button>
                            </div>
                        </div>

                        <div id="accounts-list" class="flex-1 overflow-y-auto p-5 space-y-4 bg-slate-950/50"></div>
                    </div>
                    <div id="viewer-list-placeholder" class="hidden h-full flex flex-col items-center justify-center text-slate-500">
                        <i class="ph ph-lock-key text-6xl mb-4 opacity-20"></i>
                        <p class="text-xl font-bold opacity-50">D·ªØ li·ªáu b·∫£o m·∫≠t</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL OVERLAY -->
    <div id="modal-overlay" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
        <div id="modal-content" class="w-full max-w-sm rounded-2xl p-6 shadow-2xl border animate-scale-in bg-slate-900 border-slate-700 text-white relative">
            <!-- Content Injected via JS -->
        </div>
    </div>

    <!-- LARGE MODAL OVERLAY -->
    <div id="large-modal-overlay" class="hidden fixed inset-0 z-[60] flex items-end sm:items-center justify-center sm:p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
        <div id="large-modal-content" class="w-full sm:max-w-2xl h-[80vh] sm:h-[600px] flex flex-col rounded-t-2xl sm:rounded-2xl shadow-2xl border animate-slide-in bg-slate-900 border-slate-700 text-white relative"></div>
    </div>

    <!-- CENTERED TOAST (NOTIFICATION) -->
    <div id="toast" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[100] px-6 py-4 rounded-xl shadow-2xl flex flex-col items-center justify-center gap-2 font-medium text-white transition-all duration-300 opacity-0 scale-90 invisible min-w-[200px] text-center">
        <i id="toast-icon" class="ph ph-check-circle text-4xl mb-1"></i>
        <span id="toast-message" class="text-lg">Notification</span>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let state = {
            currentUser: null,
            users: [], // Sync from Firebase
            accounts: [], // Sync from Firebase
            history: [], // Sync from Firebase
            filter: 'all',
            searchQuery: '',
            isDark: true,
            sellQuantity: 1
        };

        // --- COMMISSION LOGIC ---
        function getCommissionRate(count) {
            if (count >= 50) return 0.07;
            if (count >= 20) return 0.05;
            return 0.02;
        }

        // --- APP INITIALIZATION ---
        window.initApp = async () => {
            // Apply Theme
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme === 'light') {
                state.isDark = false;
                document.documentElement.classList.remove('dark');
            }
            updateThemeIcon();

            // Set up Realtime Listeners
            setupListeners();
            
            // Check & Seed Users if empty
            await checkAndSeedUsers();

            // Setup Auto-Updater (Client-side Timer for farming days display)
            setInterval(() => {
                if (state.currentUser && state.currentUser.role === 'admin') {
                    renderAccounts(); // Re-render to update timers visual
                }
            }, 60000);
        };

        // --- FIREBASE LISTENERS ---
        function setupListeners() {
            // Accounts
            window.onSnapshot(window.query(window.collection(window.db, "accounts")), (snapshot) => {
                state.accounts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort by createdAt desc locally for display
                state.accounts.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                
                if (state.currentUser) {
                    renderApp(); // Data change triggers render
                }
            });

            // History
            window.onSnapshot(window.query(window.collection(window.db, "history")), (snapshot) => {
                state.history = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.history.sort((a, b) => (b.soldAt || 0) - (a.soldAt || 0));
                if (state.currentUser) renderApp();
            });

            // Users
            window.onSnapshot(window.query(window.collection(window.db, "users")), (snapshot) => {
                state.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // If current user details changed in DB (e.g. password changed), update local session
                if (state.currentUser) {
                    const freshUser = state.users.find(u => u.id === state.currentUser.id);
                    if (freshUser) {
                        state.currentUser = freshUser; // Keep session sync
                        renderApp();
                    } else {
                        // User deleted? Logout
                        logout(); 
                    }
                }
            });
        }

        async function checkAndSeedUsers() {
            const userRef = window.collection(window.db, "users");
            const snap = await window.getDocs(userRef);

            // 1. Check/Create Super Admin specifically (Force Create if missing)
            const superAdminRef = window.doc(window.db, "users", "administrator");
            const superAdminSnap = await window.getDoc(superAdminRef);
            
            if (!superAdminSnap.exists()) {
                console.log("Creating Super Admin...");
                await window.setDoc(superAdminRef, {
                    id: 'administrator', username: 'administrator', password: '2122', role: 'admin', name: 'AdminScript'
                });
            }

            // 2. Seed others ONLY if totally empty
            if (snap.empty) {
                console.log("Seeding other default users...");
                const defaultUsers = [
                    { id: 'admin', username: 'Admin', password: '1111', role: 'admin', name: 'Administrator' },
                    { id: 'minh', username: 'minh', password: '1234', role: 'viewer', name: 'Minh Sale' },
                    { id: 'huy', username: 'huy', password: '1234', role: 'viewer', name: 'Huy Sale' }
                ];
                for (const u of defaultUsers) {
                    // Don't overwrite administrator if it was just created/exists
                    if (u.id !== 'administrator') {
                         await window.setDoc(window.doc(window.db, "users", u.id), u);
                    }
                }
            }
            
            // Enable login button after initial check
            document.getElementById('loading-msg').classList.add('hidden');
        }

        // --- AUTH SYSTEM ---
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const userIn = document.getElementById('login-username').value.trim();
            const passIn = document.getElementById('login-password').value.trim();
            
            if (state.users.length === 0) {
                document.getElementById('loading-msg').classList.remove('hidden');
                return;
            }

            const user = state.users.find(u => 
                u.username.toLowerCase() === userIn.toLowerCase() && u.password === passIn
            );

            if (user) {
                state.currentUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('login-error').classList.add('hidden');
                showToast(`Xin ch√†o ${user.name}!`, 'success');
                renderApp();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        });

        function logout() {
            state.currentUser = null;
            document.getElementById('app-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
        }

        // --- RENDER LOGIC ---
        function renderApp() {
            if (!state.currentUser) return;
            const isAdmin = state.currentUser.role === 'admin';

            // Header
            document.getElementById('user-name-display').textContent = state.currentUser.name;
            const roleBadge = document.getElementById('user-role-badge');
            roleBadge.textContent = isAdmin ? 'ADMIN' : 'VIEWER';
            roleBadge.className = `text-[10px] font-bold px-1.5 py-0.5 rounded uppercase text-white ${isAdmin ? 'bg-rose-500' : 'bg-blue-500'}`;

            // Visibility
            const adminEls = ['admin-controls', 'admin-list-container', 'admin-stats-container', 'admin-header-controls'];
            const viewerEls = ['viewer-placeholder', 'viewer-list-placeholder', 'viewer-stats-container', 'viewer-settings-btn'];

            if (isAdmin) {
                adminEls.forEach(id => document.getElementById(id).classList.remove('hidden'));
                viewerEls.forEach(id => document.getElementById(id).classList.add('hidden'));
                renderStats();
                renderAccounts();
            } else {
                adminEls.forEach(id => document.getElementById(id).classList.add('hidden'));
                viewerEls.forEach(id => document.getElementById(id).classList.remove('hidden'));
                renderViewerStats();
            }
        }

        function renderStats() {
            const total = state.accounts.length;
            const unsold = state.accounts.filter(a => a.status !== 'sold').length;
            const sold = state.accounts.filter(a => a.status === 'sold').length;
            const revenue = state.history.reduce((sum, h) => sum + h.price, 0);                            
